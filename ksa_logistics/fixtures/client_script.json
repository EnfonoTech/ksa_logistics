[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-11-25 13:21:10.110728",
  "module": "KSA Logistics",
  "name": "New Customer Creation Button",
  "script": "frappe.ui.form.on('Sales Invoice', {\n    custom_create_new_customer: function(frm){\n        show_customer_dialog(frm);\n    }\n});\n\nfunction show_customer_dialog(frm) {\n    let d = new frappe.ui.Dialog({\n        title: 'Create New Customer',\n        fields: [\n            {\n                label: 'Customer Name',\n                fieldname: 'customer_name',\n                fieldtype: 'Data',\n                reqd: 1\n            },\n            {\n                label: 'Customer Type',\n                fieldname: 'customer_type',\n                fieldtype: 'Select',\n                options: ['Company', 'Individual', 'Partnership'],\n                default: 'Company',\n                reqd: 1\n            },\n            {\n                label: 'Customer Name English',\n                fieldname: 'custom_customer_name_english',\n                fieldtype: 'Data'\n            },\n            {\n                label: 'VAT Registration No',\n                fieldname: 'custom_vat_registration_number',\n                fieldtype: 'Data'\n            },\n            {\n                label: 'CR No',\n                fieldname: 'custom_cr_number',\n                fieldtype: 'Data'\n            },\n            {\n                label: 'Referral Company',\n                fieldname: 'posa_referral_company',\n                fieldtype: 'Link',\n                options: 'Company',\n                // default: 'Badria Sweets'\n            }\n        ],\n        primary_action_label: 'Create Customer',\n        primary_action(values) {\n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Customer',\n                        customer_name: values.customer_name,\n                        customer_type: values.customer_type,\n                        custom_customer_name_english: values.custom_customer_name_english,\n                        custom_vat_registration_number: values.custom_vat_registration_number,\n                        custom_cr_number: values.custom_cr_number,\n                        posa_referral_company: values.posa_referral_company,\n                    }\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        frappe.show_alert({\n                            message: __('Customer {0} created successfully', [r.message.name]),\n                            indicator: 'green'\n                        });\n                        \n                        // Set the newly created customer in the form\n                        frm.set_value('customer', r.message.name);\n                        d.hide();\n                    }\n                },\n                error: function(r) {\n                    frappe.msgprint(__('Error creating customer'));\n                }\n            });\n        }\n    });\n    \n    d.show();\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-09-22 12:33:47.892037",
  "module": "KSA Logistics",
  "name": "Disable Form - Closed Jobs",
  "script": "// frappe.ui.form.on('Job Record', {\n//     refresh: function(frm) {\n//         if (frm.doc.job_status === \"Closed\" && !frm.is_new()) {\n//             frm.disable_form();\n            \n//             if (frappe.user.has_role(\"Job Manager\")) {\n//                 frm.set_df_property(\"job_status\", \"read_only\", 0);\n//                 frm.fields_dict[\"job_status\"].df.read_only = 0;\n//                 frm.refresh_field(\"job_status\");\n//             }\n//         }\n//     }\n// });\n\nfrappe.ui.form.on('Job Record', {\n    refresh: function(frm) {\n        if (frm.doc.job_status === \"Closed\" && !frm.is_new()) {\n            const canEditStatus = frappe.user.has_role(\"Job Manager\");\n\n            // Iterate over top-level fields and set read_only appropriately\n            (frm.fields || []).forEach(function(f) {\n                const name = f.df.fieldname;\n                if (!name) return;\n                if (name === \"job_status\") {\n                    frm.set_df_property(name, \"read_only\", !canEditStatus);\n                    if (frm.toggle_enable) frm.toggle_enable(name, canEditStatus);\n                } else {\n                    frm.set_df_property(name, \"read_only\", true);\n                    if (frm.toggle_enable) frm.toggle_enable(name, false);\n                }\n                frm.refresh_field(name);\n            });\n\n        } else {\n            frm.fields.forEach(function(f) {\n                if (!f.df || !f.df.fieldname) return;\n                frm.set_df_property(f.df.fieldname, \"read_only\", f.df.read_only || false);\n                frm.refresh_field(f.df.fieldname);\n            });\n        }\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-08-23 08:38:44.013842",
  "module": "KSA Logistics",
  "name": "Fetch Vouchers",
  "script": "frappe.ui.form.on('Job Record', {\n\tfetch_vouchers: function(frm) {\n\t    let total_sales = 0;\n\t\tlet total_cost = 0;\n\t\tlet promises =  [];\n        let fetching_alert = frappe.show_alert({message: __('Fetching vouchers...'), indicator: 'blue'}, 10);\n\t\t(frm.doc.vouchers2 || []).forEach(row=>{\n\t\t    if(row.voucher_type && row.voucher_id) {\n\t\t        let voucher_type = row.voucher_type.trim();\n\t\t        let voucher_id = row.voucher_id.trim();\n\t\t        if(voucher_type === 'Sales Invoice' || voucher_type === 'Purchase Invoice') {\n\t\t            frappe.model.set_value(row.doctype, row.name, 'link_type', voucher_type);\n\t\t            let p = frappe.db.get_value(voucher_type, voucher_id, ['name', 'status', 'total', 'grand_total', 'docstatus'])\n\t\t            .then(r =>{\n\t\t               if(r && r.message && r.message.name){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_record_link', r.message.name);\n\t\t               }\n\t\t               if(r && r.message && r.message.status){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'status', r.message.status);\n\t\t               }\n\t\t               if(r && r.message && r.message.total){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_totalwo_vat', r.message.total);\n\t\t                   if(voucher_type === 'Sales Invoice' && r.message.docstatus === 1) {\n    \t\t                   total_sales += flt(r.message.total);\n    \t\t               } else if(voucher_type === 'Purchase Invoice' && r.message.docstatus === 1) {\n    \t\t                   total_cost += flt(r.message.total);\n    \t\t               }\n\t\t               }\n\t\t               if(r && r.message && r.message.grand_total){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_total', r.message.grand_total);\n\t\t               }\n\t\t            })\n\t\t            .catch(err => {\n                        console.error('Error fetching Voucher', err.message);\n                        frappe.msgprint('Error fetching Voucher');\n                    });\n                    promises.push(p)\n\t\t        } else {\n\t\t            frappe.throw(\"Voucher Type should be either Sales Invoice or Purchase Invoice\")\n\t\t        }\n\t\t    }\n\t\t});\n\t\tPromise.all(promises).then(() => {\n\t\t    frm.set_value({\n\t\t        total_sales_sar: total_sales,\n\t\t        total_cost_sar: total_cost,\n\t\t        gp_sar: total_sales - total_cost\n\t\t    });\n\t\t    frm.refresh_fields(['total_sales_sar', 'total_cost_sar', 'gp_sar']);\n\t\t  //  frappe.show_alert({message: __('Vouchers Successfully Fetched'), indicator: 'green'});\n\t\t  setTimeout(() => {\n            fetching_alert.hide();\n            frappe.show_alert({ message: __('Vouchers fetched successfully!'), indicator: 'green' });\n          }, 500);\n\t\t});\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-08-23 08:44:40.355546",
  "module": "KSA Logistics",
  "name": "Indicators",
  "script": "frappe.ui.form.on(\"Job Record\", {\n    refresh: function(frm) {\n        if (frm.doc.job_type === \"Warehouse\") {\n            setTimeout(() => {\n                frm.events.render_qty_number_cards(frm);\n            }, 100);\n        }\n    },\n\n    render_qty_number_cards: function(frm) {\n        const job_record = frm.doc.name;\n\n        if (document.getElementById('my_number_cards')) return;\n\n        const dashboard = frm.$wrapper.find('.form-dashboard')[0];\n        $('<div id=\"my_number_cards\" class=\"form-dashboard-section custom-section\" style=\"display: flex; gap: 12px; flex-wrap: wrap; margin: 15px 0;\"></div>').insertAfter(dashboard);\n\n        const create_card = (label, value, color) => $(`\n            <div style=\"\n                background-color: #f8f9fa;\n                padding: 15px 20px;\n                border-radius: 8px;\n                min-width: 200px;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.08);\">\n                <div style=\"font-size: 14px; color: #6c757d;\">${label}</div>\n                <div style=\"font-size: 28px; font-weight: bold; color: ${color}; margin-top: 5px;\">${value}</div>\n            </div>\n        `);\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Purchase Receipt',\n                filters: {\n                    custom_job_record: job_record,\n                    docstatus: 1\n                },\n                fields: ['total_qty']\n            },\n            callback: function(res1) {\n                const purchaseQty = res1.message.reduce((sum, row) => sum + (row.total_qty || 0), 0);\n                $('#my_number_cards').append(create_card('Total Received Qty', purchaseQty, '#007bff'));\n\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Delivery Note',\n                        filters: {\n                            custom_job_record: job_record,\n                            docstatus: 1\n                        },\n                        fields: ['total_qty']\n                    },\n                    callback: function(res2) {\n                        const deliveryQty = res2.message.reduce((sum, row) => sum + (row.total_qty || 0), 0);\n                        $('#my_number_cards').append(create_card('Total Delivery Qty', deliveryQty, '#fd7e14'));\n                    }\n                });\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-05-04 18:21:49.851832",
  "module": "KSA Logistics",
  "name": "Job Record",
  "script": "frappe.ui.form.on('Package Details', {\n    length_cm: function(frm, cdt, cdn) {\n        updateCalculations(frm, cdt, cdn);\n    },\n    width_cm: function(frm, cdt, cdn) {\n        updateCalculations(frm, cdt, cdn);\n    },\n    height_cm: function(frm, cdt, cdn) {\n        updateCalculations(frm, cdt, cdn);\n    },\n});\n\n\nfrappe.ui.form.on('Job Record', {\n\tbranch: function(frm) {\n\t\tif(frm.doc.branch == \"Riyadh - FL\") {\n\t\t    frm.doc.region_id = \"FL\";\n\t\t} else if(frm.doc.branch == \"Jeddah - FL\") {\n\t\t    frm.doc.region_id = \"FLJ\"\n\t\t} else if(frm.doc.branch == \"Dammam - FL\") {\n\t\t    frm.doc.region_id = \"FLD\"\n\t\t}\n\t},\n\tjob_type: function(frm) {\n\t    if(frm.doc.job_type == \"Land transport\") {\n\t\t    frm.doc.job_type_id = \"LT\";\n\t\t} else if(frm.doc.job_type == \"Warehouse\") {\n\t\t    frm.doc.job_type_id = \"WH\"\n\t\t} else if(frm.doc.job_type == \"Packing\") {\n\t\t    frm.doc.job_type_id = \"PKG\"\n\t\t} else if(frm.doc.job_type == \"Crating\") {\n\t\t    frm.doc.job_type_id = \"CRA\"\n\t\t} else if(frm.doc.job_type == \"Customs Clearance\") {\n\t\t    frm.doc.job_type_id = \"CC\"\n\t\t} else if(frm.doc.job_type == \"Terminal Handling\") {\n\t\t    frm.doc.job_type_id = \"TR\"\n\t\t}\n\t\t\n\t},\n\t validate: function(frm) {\n\t    if (!frm.doc.build_by) {\n            frm.set_value('build_by', frappe.session.user);\n        }\n\t    \n        $.each(frm.doc.package_table || [], function(i, row) {\n            // Calculate Square Meters (sqmtr)\n            row.sqmtr = (row.length_cm * row.width_cm) / 10000;\n            \n            // Calculate Cubic Meters (cbm)\n            row.cbm = (row.length_cm * row.width_cm * row.height_cm) / 1000000;\n        });\n        \n        // Refresh the child table to show updated values\n        frm.refresh_field('package_table');\n        \n        // var total_quantity = 0;\n        // var total_weight = 0;\n        // var total_sqmtr = 0;\n        // var total_cbm = 0;\n        \n        // // Sum up values from all rows\n        // $.each(frm.doc.package_table || [], function(i, row) {\n        //     total_quantity += flt(row.quantity || 0);\n        //     total_weight += flt(row.weight_kg || 0);\n        //     total_sqmtr += flt(row.sqmtr || 0);\n        //     total_cbm += flt(row.cbm || 0);\n        // });\n        \n        // // Set the total fields\n        // frm.set_value('total_quantity', total_quantity);\n        // frm.set_value('total_weight', total_weight);\n        // frm.set_value('total_sqmtr', total_sqmtr);\n        // frm.set_value('total_cbm', total_cbm);\n        calculateTotals(frm);\n    },\ncustomer_name: function(frm) {\n        // Trigger when customer_name is changed\n        frm.set_query('attentions', function() {\n            return {\n                filters: {\n                    link_doctype: 'Customer',\n                    link_name: frm.doc.customer\n                }\n            };\n        });\n    },\n\n    onload: function(frm) {\n        // Also apply filter when form loads (for existing records)\n        if (frm.doc.customer_name) {\n            frm.set_query('attentions', function() {\n                return {\n                    filters: {\n                        link_doctype: 'Customer',\n                        link_name: frm.doc.customer\n                    }\n                };\n            });\n        }\n    }    \n})\n\n\nfunction updateCalculations(frm, cdt, cdn) {\n    var row = locals[cdt][cdn];\n    \n    // Calculate Square Meters (sqmtr) only if length and width are present\n    if (row.length_cm && row.width_cm) {\n        if(row.height_cm) {\n            row.sqmtr = (row.length_cm * row.width_cm) / 10000;\n            row.cbm = (row.length_cm * row.width_cm * row.height_cm) / 1000000;\n            calculateTotals(frm);\n        } else {\n            row.sqmtr = (row.length_cm * row.width_cm) / 10000;\n            row.cbm = 0;\n            calculateTotals(frm);\n        }\n        // row.sqmtr = (row.length_cm * row.width_cm) / 10000;\n    } else {\n        row.sqmtr = 0;\n        row.cbm = 0;\n        calculateTotals(frm);\n    }\n    \n    // Refresh the row\n    refresh_field('sqmtr', cdn, 'package_table');\n    refresh_field('cbm', cdn, 'package_table');\n    \n    // Update totals after changing any value\n    // calculateTotals(frm);\n}\n\n// Function to calculate totals\nfunction calculateTotals(frm) {\n    var total_quantity = 0;\n    var total_weight = 0;\n    var total_sqmtr = 0;\n    var total_cbm = 0;\n    \n    // Sum up values from all rows\n    $.each(frm.doc.package_table || [], function(i, row) {\n        total_quantity += flt(row.quantity || 0);\n        total_weight += flt(row.weight_kg * row.quantity || 0);\n        total_sqmtr += flt(row.sqmtr * row.quantity || 0);\n        total_cbm += flt(row.cbm * row.quantity || 0);\n    });\n    \n    // Set the total fields\n    frm.set_value('total_quantity', total_quantity);\n    frm.set_value('total_weight', total_weight);\n    frm.set_value('total_sqmtr', total_sqmtr);\n    frm.set_value('total_cbm', total_cbm);\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-05-08 08:06:53.699467",
  "module": "KSA Logistics",
  "name": "Hide Advanced Search",
  "script": "frappe.ui.form.on('Job Record', {\n    refresh: function(frm) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Operational Information', {\n    operational_informations_add: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    },\n    operational_informations_remove: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    },\n    operational_status: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    }\n});\n\nfunction update_current_status(frm) {\n    const child = frm.doc.operational_informations;\n    let new_status = \"\";\n\n    if (child && child.length > 0) {\n        new_status = child[child.length - 1].operational_status || \"\";\n    }\n\n    if (frm.doc.current_operational_status !== new_status) {\n        frm.set_value(\"current_operational_status\", new_status).then(() => {\n            if (!frm.is_new()) {\n                frm.save();\n            }\n        });\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-11-21 14:03:52.062027",
  "module": "KSA Logistics",
  "name": "W/O  Vat",
  "script": "frappe.ui.form.on(\"Job Record\", {\n    refresh: function(frm) {\n        \n        frm.events.set_financial_indicators(frm);\n    },\n\n    set_financial_indicators: function(frm) {\n        function process_invoices(invoices, includeOutstanding = false) {\n            var totals = {\n                grandTotal: 0,\n                baseTotal: 0,\n                outstandingTotal: 0\n            };\n            if (invoices && invoices.length > 0) {\n                invoices.forEach(function(invoice) {\n                    totals.grandTotal += invoice.base_grand_total || 0;\n                    totals.baseTotal += invoice.base_total || 0;\n                    if (includeOutstanding) {\n                        totals.outstandingTotal += invoice.outstanding_amount || 0;\n                    }\n                });\n            }\n            return totals;\n        }\n\n        function process_journal_entries(entries) {\n            var totalDebit = 0;\n            if (entries && entries.length > 0) {\n                entries.forEach(function(entry) {\n                    totalDebit += entry.total_debit || 0;\n                });\n            }\n            return totalDebit;\n        }\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Sales Invoice',\n                filters: {\n                    custom_job_record: frm.doc.name,\n                    docstatus: 1\n                },\n                fields: ['base_grand_total', 'base_total', 'outstanding_amount']\n            },\n            callback: function(response) {\n                var salesInvoiceTotals = process_invoices(response.message, true);\n\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Purchase Invoice',\n                        filters: {\n                            custom_job_record: frm.doc.name,\n                            docstatus: 1\n                        },\n                        fields: ['base_grand_total', 'base_total', 'outstanding_amount']\n                    },\n                    callback: function(response) {\n                        var purchaseInvoiceTotals = process_invoices(response.message, true);\n\n                        frappe.call({\n                            method: 'frappe.client.get_list',\n                            args: {\n                                doctype: 'Journal Entry',\n                                filters: {\n                                    custom_job_record: frm.doc.name,\n                                    docstatus: 1\n                                },\n                                fields: ['total_debit']\n                            },\n                            callback: function(response) {\n                                var journalEntryTotalDebit = process_journal_entries(response.message);\n\n                                var totalExpenses = purchaseInvoiceTotals.baseTotal + journalEntryTotalDebit;\n                                var profitAndLoss = salesInvoiceTotals.baseTotal - totalExpenses;\n\n                                \n                                frm.dashboard.add_indicator(\n                                    __('Sales Invoice (W/O VAT): {0}', [format_currency(salesInvoiceTotals.baseTotal, frm.doc.currency)]),\n                                    'blue'\n                                );\n                                \n                                frm.dashboard.add_indicator(\n                                    __('Purchase Invoice (W/O VAT): {0}', [format_currency(purchaseInvoiceTotals.baseTotal, frm.doc.currency)]),\n                                    'orange'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('Journal Entries: {0}', [format_currency(journalEntryTotalDebit, frm.doc.currency)]),\n                                    'purple'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('P&L: {0}', [format_currency(profitAndLoss, frm.doc.currency)]),\n                                    profitAndLoss >= 0 ? 'green' : 'red'\n                                );\n                                \n                                // Add additional indicators from job_record.js\n                                frm.events.set_dashboard_indicators && frm.events.set_dashboard_indicators(frm);\n                            }\n                        });\n                    }\n                });\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-11-21 14:04:51.307409",
  "module": "KSA Logistics",
  "name": "vouchers",
  "script": "frappe.ui.form.on('Job Record', {\n    refresh(frm) {\n        if (!frm.is_new()) {\n            frm.add_custom_button('Fetch Linked Vouchers', async () => {\n                const sources = [\n                    { doctype: 'Sales Invoice', label: 'Sales Invoice', name_field: 'customer_name', amount_field: 'base_total' },\n                    { doctype: 'Purchase Invoice', label: 'Purchase Invoice', name_field: 'supplier', amount_field: 'base_total' },\n                    { doctype: 'Journal Entry', label: 'Journal Entry', name_field: 'name', amount_field: 'total_debit' }\n                ];\n\n                let added = false;\n\n                for (let source of sources) {\n                    const res = await frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: source.doctype,\n                            filters: {\n                                custom_job_record: frm.doc.name,\n                                docstatus: 1\n                            },\n                            fields: ['name', source.name_field, source.amount_field]\n                        }\n                    });\n\n                    if (res.message) {\n                        res.message.forEach(doc => {\n                            const already_exists = frm.doc.vouchers2.some(row =>\n                                row.voucher_type === source.label && row.voucher_id === doc.name\n                            );\n\n                            if (!already_exists) {\n                                const row = frm.add_child('vouchers2');\n                                row.voucher_type = source.label;\n                                row.voucher_id = doc.name;\n                                row.name1 = doc[source.name_field];\n                                row.amount = doc[source.amount_field];\n                                added = true;\n                            }\n                        });\n                    }\n                }\n\n                if (added) {\n                    frm.refresh_field('vouchers2');\n                    await frm.save();\n                    frappe.msgprint(__('Linked submitted vouchers fetched and saved.'));\n                } else {\n                    frappe.msgprint(__('No new submitted vouchers to add.'));\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-11-21 14:05:43.156879",
  "module": "KSA Logistics",
  "name": "OP status",
  "script": "frappe.ui.form.on('Job Record', {\n    refresh: function(frm) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Operational Information', {\n    operational_informations_add: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    },\n    operational_informations_remove: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    },\n    operational_status: function(frm, cdt, cdn) {\n        if (!frm.is_new()) {\n            update_current_status(frm);\n        }\n    }\n});\n\nfunction update_current_status(frm) {\n    const child = frm.doc.operational_informations;\n    let new_status = \"\";\n\n    if (child && child.length > 0) {\n        new_status = child[child.length - 1].operational_status || \"\";\n    }\n\n    if (frm.doc.current_operational_status !== new_status) {\n        frm.set_value(\"current_operational_status\", new_status).then(() => {\n            if (!frm.is_new()) {\n                frm.save();\n            }\n        });\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.736740",
  "module": "KSA Logistics",
  "name": "Disable Form - Closed Warehouse Jobs",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n    refresh: function(frm) {\n        if (frm.doc.job_status === \"Closed\" && !frm.is_new()) {\n            const canEditStatus = frappe.user.has_role(\"Job Manager\");\n\n            // Iterate over top-level fields and set read_only appropriately\n            (frm.fields || []).forEach(function(f) {\n                const name = f.df.fieldname;\n                if (!name) return;\n                if (name === \"job_status\") {\n                    frm.set_df_property(name, \"read_only\", !canEditStatus);\n                    if (frm.toggle_enable) frm.toggle_enable(name, canEditStatus);\n                } else {\n                    frm.set_df_property(name, \"read_only\", true);\n                    if (frm.toggle_enable) frm.toggle_enable(name, false);\n                }\n                frm.refresh_field(name);\n            });\n\n        } else {\n            frm.fields.forEach(function(f) {\n                if (!f.df || !f.df.fieldname) return;\n                frm.set_df_property(f.df.fieldname, \"read_only\", f.df.read_only || false);\n                frm.refresh_field(f.df.fieldname);\n            });\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.761088",
  "module": "KSA Logistics",
  "name": "Fetch Vouchers - WJR",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n\tfetch_vouchers: function(frm) {\n\t    let total_sales = 0;\n\t\tlet total_cost = 0;\n\t\tlet promises =  [];\n        let fetching_alert = frappe.show_alert({message: __('Fetching vouchers...'), indicator: 'blue'}, 10);\n\t\t(frm.doc.vouchers || []).forEach(row=>{\n\t\t    if(row.voucher_type && row.voucher_id) {\n\t\t        let voucher_type = row.voucher_type.trim();\n\t\t        let voucher_id = row.voucher_id.trim();\n\t\t        if(voucher_type === 'Sales Invoice' || voucher_type === 'Purchase Invoice') {\n\t\t            frappe.model.set_value(row.doctype, row.name, 'link_type', voucher_type);\n\t\t            let p = frappe.db.get_value(voucher_type, voucher_id, ['name', 'status', 'total', 'grand_total', 'docstatus'])\n\t\t            .then(r =>{\n\t\t               if(r && r.message && r.message.name){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_record_link', r.message.name);\n\t\t               }\n\t\t               if(r && r.message && r.message.status){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'status', r.message.status);\n\t\t               }\n\t\t               if(r && r.message && r.message.total){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_totalwo_vat', r.message.total);\n\t\t                   if(voucher_type === 'Sales Invoice' && r.message.docstatus === 1) {\n    \t\t                   total_sales += flt(r.message.total);\n    \t\t               } else if(voucher_type === 'Purchase Invoice' && r.message.docstatus === 1) {\n    \t\t                   total_cost += flt(r.message.total);\n    \t\t               }\n\t\t               }\n\t\t               if(r && r.message && r.message.grand_total){\n\t\t                   frappe.model.set_value(row.doctype, row.name, 'voucher_total', r.message.grand_total);\n\t\t               }\n\t\t            })\n\t\t            .catch(err => {\n                        console.error('Error fetching Voucher', err.message);\n                        frappe.msgprint('Error fetching Voucher');\n                    });\n                    promises.push(p)\n\t\t        } else {\n\t\t            frappe.throw(\"Voucher Type should be either Sales Invoice or Purchase Invoice\")\n\t\t        }\n\t\t    }\n\t\t});\n\t\tPromise.all(promises).then(() => {\n\t\t    frm.set_value({\n\t\t        total_sales_sar: total_sales,\n\t\t        total_cost_sar: total_cost,\n\t\t        gp_sar: total_sales - total_cost\n\t\t    });\n\t\t    frm.refresh_fields(['custom_total_sales_sar', 'custom_total_cost_sar', 'custom_gp_sar']);\n\t\t  //  frappe.show_alert({message: __('Vouchers Successfully Fetched'), indicator: 'green'});\n\t\t  setTimeout(() => {\n            fetching_alert.hide();\n            frappe.show_alert({ message: __('Vouchers fetched successfully!'), indicator: 'green' });\n          }, 500);\n\t\t});\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.784889",
  "module": "KSA Logistics",
  "name": "Cost - Revenue Stats",
  "script": "frappe.ui.form.on(\"Warehouse Job Record\", {\n    refresh: function(frm) {\n        if(!frm.is_new()){\n            frm.events.set_financial_indicators(frm);   \n        }\n    },\n\n    set_financial_indicators: function(frm) {\n        function process_invoices(invoices, includeOutstanding = false) {\n            var totals = {\n                grandTotal: 0,\n                baseTotal: 0,\n                outstandingTotal: 0\n            };\n            if (invoices && invoices.length > 0) {\n                invoices.forEach(function(invoice) {\n                    totals.grandTotal += invoice.base_grand_total || 0;\n                    totals.baseTotal += invoice.base_total || 0;\n                    if (includeOutstanding) {\n                        totals.outstandingTotal += invoice.outstanding_amount || 0;\n                    }\n                });\n            }\n            return totals;\n        }\n\n        function process_journal_entries(entries) {\n            var totalDebit = 0;\n            if (entries && entries.length > 0) {\n                entries.forEach(function(entry) {\n                    totalDebit += entry.total_debit || 0;\n                });\n            }\n            return totalDebit;\n        }\n\n        frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Sales Invoice',\n                filters: {\n                    custom_warehouse_job_record: frm.doc.name,\n                    docstatus: 1\n                },\n                fields: ['base_grand_total', 'base_total', 'outstanding_amount']\n            },\n            callback: function(response) {\n                var salesInvoiceTotals = process_invoices(response.message, true);\n\n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Purchase Invoice',\n                        filters: {\n                            custom_warehouse_job_record: frm.doc.name,\n                            docstatus: 1\n                        },\n                        fields: ['base_grand_total', 'base_total', 'outstanding_amount']\n                    },\n                    callback: function(response) {\n                        var purchaseInvoiceTotals = process_invoices(response.message, true);\n\n                        frappe.call({\n                            method: 'frappe.client.get_list',\n                            args: {\n                                doctype: 'Journal Entry',\n                                filters: {\n                                    custom_warehouse_job_record: frm.doc.name,\n                                    docstatus: 1\n                                },\n                                fields: ['total_debit']\n                            },\n                            callback: function(response) {\n                                var journalEntryTotalDebit = process_journal_entries(response.message);\n\n                                // Calculate totals for snippet 1 (with VAT - grand totals)\n                                var totalExpensesWithVAT = purchaseInvoiceTotals.grandTotal + journalEntryTotalDebit;\n                                var profitAndLossWithVAT = salesInvoiceTotals.grandTotal - totalExpensesWithVAT;\n\n                                // Calculate totals for snippet 2 (without VAT - base totals)\n                                var totalExpensesWithoutVAT = purchaseInvoiceTotals.baseTotal + journalEntryTotalDebit;\n                                var profitAndLossWithoutVAT = salesInvoiceTotals.baseTotal - totalExpensesWithoutVAT;\n\n                                // First set of indicators (from snippet 1 - with VAT)\n                                frm.dashboard.add_indicator(\n                                    __('Total Sales Invoice: {0}', [format_currency(salesInvoiceTotals.grandTotal, frm.doc.currency)]), \n                                    'blue'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('Total Purchase Invoice: {0}', [format_currency(purchaseInvoiceTotals.grandTotal, frm.doc.currency)]), \n                                    'orange'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('Total Journal Entries: {0}', [format_currency(journalEntryTotalDebit, frm.doc.currency)]), \n                                    'purple'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('P&L: {0}', [format_currency(profitAndLossWithVAT, frm.doc.currency)]), \n                                    profitAndLossWithVAT >= 0 ? 'green' : 'red'\n                                );\n\n                                // Second set of indicators (from snippet 2 - without VAT)\n                                frm.dashboard.add_indicator(\n                                    __('Sales Invoice (W/O VAT): {0}', [format_currency(salesInvoiceTotals.baseTotal, frm.doc.currency)]),\n                                    'blue'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('Purchase Invoice (W/O VAT): {0}', [format_currency(purchaseInvoiceTotals.baseTotal, frm.doc.currency)]),\n                                    'orange'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('Journal Entries: {0}', [format_currency(journalEntryTotalDebit, frm.doc.currency)]),\n                                    'purple'\n                                );\n                                frm.dashboard.add_indicator(\n                                    __('P&L: {0}', [format_currency(profitAndLossWithoutVAT, frm.doc.currency)]),\n                                    profitAndLossWithoutVAT >= 0 ? 'green' : 'red'\n                                );\n                            }\n                        });\n                    }\n                });\n            }\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.810211",
  "module": "KSA Logistics",
  "name": "Table Calculation",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n\trefresh(frm) {\n\t\tupdate_all_balances(frm);\n\t},\n});\n\nfrappe.ui.form.on('Stock Movement Detail', {\n\tin_volume(frm, cdt, cdn) {\n\t\tupdate_all_balances(frm);\n\t},\n\tout_volume(frm, cdt, cdn) {\n\t\tupdate_all_balances(frm);\n\t},\n\tin_qty(frm, cdt, cdn) {\n\t    update_qty_totals(frm);\n\t},\n\tout_qty(frm,cdt,cdn) {\n\t    update_qty_totals(frm);\n\t},\n\tstock_movement_detail_add(frm, cdt, cdn) {\n\t\tupdate_all_balances(frm);\n\t},\n\ttable_jjim_remove(frm, cdt, cdn){\n\t    update_qty_totals(frm);\n\t}\n});\n\nfunction update_all_balances(frm) {\n\tlet previous_balance = 0;\n\n\t(frm.doc.table_jjim || []).forEach(row => {\n\t\tconst in_volume = row.in_volume || 0;\n\t\tconst out_volume = row.out_volume || 0;\n\t\tconst balance = previous_balance + (in_volume - out_volume);\n\n\t\tfrappe.model.set_value(row.doctype, row.name, 'balance', balance);\n\n\t\tprevious_balance = balance;\n\t});\n}\n\nfunction update_qty_totals(frm)  {\n    in_totals = 0.0;\n    out_totals = 0.0;\n    \n    (frm.doc.table_jjim || []).forEach(row => {\n        in_totals += flt(row.in_qty);\n        out_totals += flt(row.out_qty);\n    })\n    \n    frappe.model.set_value(frm.doctype, frm.docname, 'total_in_qty', in_totals);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_out_qty', out_totals);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.841998",
  "module": "KSA Logistics",
  "name": "WH Attention",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n    onload: function(frm) {\n        if (frm.doc.customer) {\n            frm.set_query('attention', function() {\n                return {\n                    filters: {\n                        link_doctype: 'Customer',\n                        link_name: frm.doc.customer\n                    }\n                };\n            });\n            frm.set_query('quotation', function() {\n                return {\n                    filters: {\n                        quotation_to: 'Customer',\n                        party_name: frm.doc.customer\n                    }\n                };\n            });\n        }\n    },\n\n    customer: function(frm) {\n        frm.set_value('attention', null);\n        frm.set_value('quotation', null);\n        if (frm.doc.customer) {\n            frm.set_query('attention', function() {\n                return {\n                    filters: {\n                        link_doctype: 'Customer',\n                        link_name: frm.doc.customer\n                    }\n                };\n            });\n            frm.set_query('quotation', function() {\n                return {\n                    filters: {\n                        quotation_to: 'Customer',\n                        party_name: frm.doc.customer\n                    }\n                };\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.869329",
  "module": "KSA Logistics",
  "name": "New Job",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n    refresh(frm) {\n        if (!frm.is_new()) {\n            frm.add_custom_button('Create New Warehouse Job Record', () => {\n                open_custom_date_dialog(frm);\n            });\n        }\n    },\n    \n    validate: function(frm) {\n        if (!frm.doc.created_by) {\n            frm.set_value('created_by', frappe.session.user);\n        }\n    }\n});\n\nfunction open_custom_date_dialog(frm) {\n    const d = new frappe.ui.Dialog({\n        title: 'Create New Job Record',\n        fields: [\n            {\n                label: 'New Job Date',\n                fieldname: 'job_date',\n                fieldtype: 'Date',\n                reqd: 1,\n                default: frappe.datetime.get_today()\n            }\n        ],\n        primary_action_label: 'Create',\n        primary_action(values) {\n            d.hide();\n            create_new_job_record(frm, values.job_date);\n        }\n    });\n\n    d.show();\n}\n\nfunction create_new_job_record(frm, new_job_date) {\n    if (frm.doc.succeeding_job) {\n        frappe.msgprint({\n            title: 'Succeeding Job Already Exists',\n            message: `This job already has a succeeding job: <b>${frm.doc.succeeding_job}</b>`,\n            indicator: 'orange'\n        });\n\n        return;\n    }\n\n    const child_table_data = (frm.doc.table_jjim || []).map(row => ({\n        date: row.date,\n        warehouse: row.warehouse,\n        description: row.description,\n        uom: row.uom,\n        in_qty: row.in_qty,\n        out_qty: row.out_qty,\n        grn: row.grn,\n        gdn: row.gdn,\n        in_volume: row.in_volume,\n        out_volume: row.out_volume,\n        balance: row.balance,\n        remarks: row.remarks,\n        doctype: \"table_jjim\"\n    }));\n\n    frappe.call({\n        method: 'frappe.client.insert',\n        args: {\n            doc: {\n                doctype: 'Warehouse Job Record',\n                job: frm.doc.job,\n                job_date: new_job_date,\n                reference_date: new_job_date,\n                preceding_job: frm.doc.name,\n                auto_created: 1,\n                reference_type: frm.doc.reference_type,\n                reference_criteria: frm.doc.reference_criteria,\n                storage_terms: frm.doc.storage_terms,\n                billing_criteria: frm.doc.billing_criteria,\n                cargo_type: frm.doc.cargo_type,\n                warehouses: frm.doc.warehouses?.map(w => ({\n                    warehouse: w.warehouse,\n                    doctype: 'Warehouse Job Record'\n                })) || [],\n                table_jjim: child_table_data\n            }\n        },\n        callback(r) {\n            if (!r.exc) {\n                frappe.msgprint('New Job Record Created: ' + r.message.name);\n\n                frappe.call({\n                    method: 'frappe.client.set_value',\n                    args: {\n                        doctype: 'Warehouse Job Record',\n                        name: frm.doc.name,\n                        fieldname: 'succeeding_job',\n                        value: r.message.name\n                    },\n                    callback() {\n                        frm.reload_doc();\n                    }\n                });\n\n                frappe.set_route('Form', 'Warehouse Job Record', r.message.name);\n            }\n        }\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Warehouse Job Record",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.893710",
  "module": "KSA Logistics",
  "name": "Warehouse Vouchers",
  "script": "frappe.ui.form.on('Warehouse Job Record', {\n    refresh(frm) {\n        if (!frm.is_new()) {\n            frm.add_custom_button('Fetch Linked Vouchers', async () => {\n                const sources = [\n                    { doctype: 'Sales Invoice', label: 'Sales Invoice', name_field: 'customer_name', amount_field: 'base_total' },\n                    { doctype: 'Purchase Invoice', label: 'Purchase Invoice', name_field: 'supplier', amount_field: 'base_total' },\n                    { doctype: 'Journal Entry', label: 'Journal Entry', name_field: 'name', amount_field: 'total_debit' }\n                ];\n\n                let added = false;\n\n                for (let source of sources) {\n                    const res = await frappe.call({\n                        method: 'frappe.client.get_list',\n                        args: {\n                            doctype: source.doctype,\n                            filters: {\n                                custom_warehouse_job_record: frm.doc.name,\n                                docstatus: 1\n                            },\n                            fields: ['name', source.name_field, source.amount_field]\n                        }\n                    });\n\n                    if (res.message) {\n                        res.message.forEach(doc => {\n                            const already_exists = frm.doc.vouchers.some(row =>\n                                row.voucher_type === source.label && row.voucher_id === doc.name\n                            );\n\n                            if (!already_exists) {\n                                const row = frm.add_child('vouchers');\n                                row.voucher_type = source.label;\n                                row.voucher_id = doc.name;\n                                row.name1 = doc[source.name_field];\n                                row.amount = doc[source.amount_field];\n                                added = true;\n                            }\n                        });\n                    }\n                }\n\n                if (added) {\n                    frm.refresh_field('vouchers');\n                    await frm.save();\n                    frappe.msgprint(__('Linked submitted vouchers fetched and saved.'));\n                } else {\n                    frappe.msgprint(__('No new submitted vouchers to add.'));\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Survey Report",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.921608",
  "module": "KSA Logistics",
  "name": "Auto Calculate Volume and Area in Cargo Details",
  "script": "frappe.ui.form.on('Packing List Item', {\n    length_cm: function(frm, cdt, cdn) {\n        calculate_volume(frm, cdt, cdn);\n    },\n    width_cm: function(frm, cdt, cdn) {\n        calculate_volume(frm, cdt, cdn);\n    },\n    height_cm: function(frm, cdt, cdn) {\n        calculate_volume(frm, cdt, cdn);\n    }\n});\n\nfunction calculate_volume(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n\n    if (row.length_cm && row.width_cm && row.height_cm) {\n        frappe.model.set_value(cdt, cdn, \"volume_cbm\",\n            (row.length_cm * row.width_cm * row.height_cm) / 1000000\n        );\n        frappe.model.set_value(cdt, cdn, \"volume_sqrmtr\",\n            (row.length_cm * row.width_cm) / 10000\n        );\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Survey Report",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.948125",
  "module": "KSA Logistics",
  "name": "Customer filter on Attention",
  "script": "frappe.ui.form.on('Survey Report', {\n\tonload: function(frm){\n\t    if (frm.doc.customer) {\n            frm.set_query('attention', function() {\n                return {\n                    filters: {\n                        link_doctype: 'Customer',\n                        link_name: frm.doc.customer\n                    }\n                };\n            });\n        }\n\t},\n\tcustomer:function(frm){\n\t    if (frm.doc.customer) {\n            frm.set_query('attention', function() {\n                return {\n                    filters: {\n                        link_doctype: 'Customer',\n                        link_name: frm.doc.customer\n                    }\n                };\n            });\n        }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Packing List",
  "enabled": 1,
  "modified": "2025-11-25 13:06:13.975221",
  "module": "KSA Logistics",
  "name": "Set fields on selecting Warehouse Job Record",
  "script": "frappe.ui.form.on('Packing List', {\n\twarehouse_job_record: function(frm) {\n\t\tif(frm.doc.warehouse_job_record) {\n\t\t    frm.set_value(\"job_record\", \"\");\n\t\t    frappe.db.get_value(\"Warehouse Job Record\", frm.doc.warehouse_job_record, [\"name\", \"customer\", \"branch\", \"attention\"])\n\t\t    .then(r=>{\n\t\t        if(r && r.message){\n\t\t            if(r.message.branch){\n\t\t                frm.set_value(\"branch\", r.message.branch);\n\t\t            }\n\t\t            if(r.message.customer){\n\t\t                frm.set_value(\"customer\", r.message.customer);\n\t\t            }\n\t\t            if(r.message.attention){\n\t\t                frm.set_value(\"attention\", r.message.attention);\n\t\t            }\n\t\t        }\n\t\t    });\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Packing List",
  "enabled": 1,
  "modified": "2025-11-25 13:06:14.003270",
  "module": "KSA Logistics",
  "name": "Calculation",
  "script": "frappe.ui.form.on('Packing List Item', {\n    length_cm: update_row_and_totals,\n    width_cm: update_row_and_totals,\n    height_cm: update_row_and_totals,\n    weight_kg: update_row_and_totals,\n    item_remove: function(frm) {\n        calculate_totals(frm);  \n    }\n});\n\nfrappe.ui.form.on('Packing List', {\n    // onload: function(frm) {\n    //     calculate_totals(frm);\n    // },\n    validate: function(frm) {\n        calculate_totals(frm);\n    },\n    item_on_form_rendered: function(frm) {\n        calculate_totals(frm);\n    },\n    // item_remove: function(frm) {\n    //     calculate_totals(frm);  \n    // }\n});\n\nfunction update_row_and_totals(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n\n    let length = flt(row.length_cm);\n    let width = flt(row.width_cm);\n    let height = flt(row.height_cm);\n\n    let cbm = 0;\n    if (length && width && height) {\n        cbm = (length * width * height) / 1000000;\n    }\n\n    let sqm = 0;\n    if (length && width) {\n        sqm = (length * width) / 10000;\n    }\n\n    frappe.model.set_value(cdt, cdn, \"volume_cbm\", cbm);\n    frappe.model.set_value(cdt, cdn, \"volume_sqrmtr\", sqm);\n\n    calculate_totals(frm);\n}\n\nfunction calculate_totals(frm) {\n    let total_weight = 0;\n    let total_cbm = 0;\n    let total_sqm = 0;\n\n    (frm.doc.item || []).forEach(row => {\n        total_weight += flt(row.weight_kg);\n        total_cbm += flt(row.volume_cbm);\n        total_sqm += flt(row.volume_sqrmtr);\n    });\n\n    // frm.set_value(\"total_weight_kg\", total_weight);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_weight_kg', total_weight);\n    // frm.set_value(\"total_volume_cbm\", total_cbm);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_volume_cbm', total_cbm);\n    // frm.set_value(\"total_volume_sqrmtr\", total_sqm);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_volume_sqrmtr', total_sqm);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Packing List",
  "enabled": 1,
  "modified": "2025-11-25 13:06:14.028580",
  "module": "KSA Logistics",
  "name": "Set Created By",
  "script": "frappe.ui.form.on('Packing List', {\n\tbefore_save: function(frm) {\n\t\tif(frm.is_new()){\n\t\t    frm.set_value('created_by', frappe.session.user)\n\t\t}\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 1,
  "modified": "2025-11-30 11:38:37.122882",
  "module": null,
  "name": "Connection Hide",
  "script": "frappe.ui.form.on(\"Job Record\", {\n    refresh(frm) {\n        toggle_sales_invoice_connection(frm);\n    },\n    job_status(frm) {\n        toggle_sales_invoice_connection(frm);  \n    }\n});\n\nfunction toggle_sales_invoice_connection(frm) {\n\n    const is_completed = frm.doc.job_status === \"Completed\";\n\n    setTimeout(() => {\n        const connection = $(\"[data-doctype='Sales Invoice']\")\n            .closest(\".document-link, li, .list-row\");\n\n        if (connection.length) {\n            connection.toggle(is_completed);  \n        } else {\n            console.debug(\"Sales Invoice connection element not found yet.\");\n        }\n\n    }, 400);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Record",
  "enabled": 0,
  "modified": "2025-12-20 14:52:54.519284",
  "module": null,
  "name": "testt",
  "script": "frappe.ui.form.on(\"Job Record\", {\n\n    refresh(frm) {\n        if (frm.doc.__islocal) return;\n\n        // Hide button if invoice already created\n        if (frm.doc.invoice_status === \"Invoice Created\") {\n            return;\n        }\n\n        frm.add_custom_button(\"Create Sales Invoice\", () => {\n            frm.events.create_sales_invoice(frm);\n        });\n    },\n\n    async create_sales_invoice(frm) {\n\n        // ---------------- DUPLICATE CHECK (v15 SAFE) ----------------\n        const existing_invoice = await frappe.db.get_list(\"Sales Invoice\", {\n            filters: {\n                custom_job_record: frm.doc.name\n            },\n            fields: [\"name\", \"docstatus\"],\n            limit: 1\n        });\n\n        if (existing_invoice.length && existing_invoice[0].docstatus !== 2) {\n            frappe.msgprint({\n                title: __(\"Duplicate Invoice\"),\n                message: __(\"A Sales Invoice already exists for this Job Record.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        // ---------------- BASIC VALIDATIONS ----------------\n        if (!frm.doc.invoice_item || !frm.doc.invoice_item.length) {\n            frappe.msgprint({\n                title: __(\"No Items\"),\n                message: __(\"Please add at least one row in <b>Invoice Items</b>.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        if (!frm.doc.company) {\n            frappe.msgprint({\n                title: __(\"Missing Company\"),\n                message: __(\"Company is required in Job Record.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        if (!frm.doc.customer) {\n            frappe.msgprint({\n                title: __(\"Missing Customer\"),\n                message: __(\"Customer is required in Job Record.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        // ---------------- FETCH DEFAULT VAT TEMPLATE ----------------\n        const templates = await frappe.db.get_list(\n            \"Sales Taxes and Charges Template\",\n            {\n                filters: {\n                    company: frm.doc.company,\n                    is_default: 1,\n                    disabled: 0\n                },\n                fields: [\"name\"],\n                limit: 1\n            }\n        );\n\n        if (!templates.length) {\n            frappe.msgprint({\n                title: __(\"VAT Not Configured\"),\n                message: __(\"No default Sales Taxes and Charges Template found for this Company.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        const tax_template = templates[0].name;\n\n        const template_doc = await frappe.db.get_doc(\n            \"Sales Taxes and Charges Template\",\n            tax_template\n        );\n\n        if (!template_doc.taxes || !template_doc.taxes.length) {\n            frappe.msgprint({\n                title: __(\"VAT Template Error\"),\n                message: __(\"Default Sales Tax Template has no tax rows.\"),\n                indicator: \"red\"\n            });\n            return;\n        }\n\n        const taxes = template_doc.taxes.map(t => ({\n            charge_type: t.charge_type,\n            account_head: t.account_head,\n            description: t.description,\n            rate: t.rate,\n            included_in_print_rate: t.included_in_print_rate || 0\n        }));\n\n        // ---------------- BUILD ITEMS (NO AMOUNT) ----------------\n        const items = frm.doc.invoice_item.map(row => {\n            if (!row.item || !row.qty || !row.rate) {\n                frappe.throw(__(\"Item, Qty and Rate are mandatory in Invoice Items\"));\n            }\n\n            return {\n                item_code: row.item,\n                qty: row.qty,\n                rate: row.rate,\n                custom_container_no: frm.doc.custom_container_no\n            };\n        });\n\n        // ---------------- CREATE SALES INVOICE ----------------\n        frappe.call({\n            method: \"frappe.client.insert\",\n            args: {\n                doc: {\n                    doctype: \"Sales Invoice\",\n                    company: frm.doc.company,\n                    customer: frm.doc.customer,\n                    cost_center: frm.doc.branch,\n                    posting_date: frappe.datetime.get_today(),\n                    custom_job_record: frm.doc.name,\n\n                    taxes_and_charges: tax_template,\n                    taxes: taxes,\n                    items: items\n                }\n            },\n            callback(r) {\n                if (!r.exc) {\n\n                    // ---------------- UPDATE JOB RECORD STATUS ----------------\n                    frappe.db.set_value(\n                        \"Job Record\",\n                        frm.doc.name,\n                        \"invoice_status\",\n                        \"Invoice Created\"\n                    );\n\n                    frappe.msgprint({\n                        message: __(\"Sales Invoice created successfully (Draft)\"),\n                        indicator: \"green\"\n                    });\n\n                    frappe.set_route(\"Form\", \"Sales Invoice\", r.message.name);\n                }\n            }\n        });\n    }\n});\n",
  "view": "Form"
 }
]