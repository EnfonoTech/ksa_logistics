[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-07 09:22:58.272934",
  "module": "KSA Logistics",
  "name": "Validate Job Closure",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Record",
  "script": "if doc.job_status == \"Closed\":\n\n    purchase_invoices = frappe.db.get_all(\"Purchase Invoice\", \n        filters={\n            \"custom_job_record\": doc.name,\n            \"docstatus\": 0\n        },\n        fields=[\"name\", \"supplier\", \"grand_total\"]\n    )\n\n    sales_invoices = frappe.db.get_all(\"Sales Invoice\",\n        filters={\n            \"custom_job_record\": doc.name, \n            \"docstatus\": 0\n        },\n        fields=[\"name\", \"customer\", \"grand_total\"]\n    )\n    \n    if purchase_invoices or sales_invoices:\n        error_msg = \"Pending vouchers to be Submitted/Cancelled\"\n        \n        frappe.throw(error_msg, title=_(\"Cannot close Job\"))\n        \n    purchase_invoices_again = frappe.db.get_all(\"Purchase Invoice\", \n        filters={\n            \"custom_job_record\": doc.name,\n            \"docstatus\": [\"in\", [1, 2]]\n        },\n        fields=[\"name\", \"supplier\", \"grand_total\"]\n    )\n\n    sales_invoices_again = frappe.db.get_all(\"Sales Invoice\",\n        filters={\n            \"custom_job_record\": doc.name, \n            \"docstatus\": [\"in\", [1, 2]]\n        },\n        fields=[\"name\", \"customer\", \"grand_total\"]\n    )\n    \n    if not purchase_invoices_again and not sales_invoices_again:\n        error_msg = \"There needs to be atleast one voucher against the Job to close it.\"\n        \n        frappe.throw(error_msg, title=_(\"Cannot close Job\"))\n        \nif doc.job_status == \"Cancelled\":\n    \n    \n    if not frappe.db.exists(\"Has Role\", {\n        \"parent\": frappe.session.user,\n        \"role\": \"Job Manager\"\n    }):\n        error_msg = f\"User {frappe.session.user} does not have the permission to cancel Jobs.\"\n        \n        frappe.throw(error_msg, title=_(\"Action Unauthorized\"))\n    \n    purchase_invoices = frappe.db.get_all(\"Purchase Invoice\", \n        filters={\n            \"custom_job_record\": doc.name,\n            \"docstatus\": [\"in\", [0, 1]]\n        },\n        fields=[\"name\", \"supplier\", \"grand_total\"]\n    )\n\n    sales_invoices = frappe.db.get_all(\"Sales Invoice\",\n        filters={\n            \"custom_job_record\": doc.name, \n            \"docstatus\": [\"in\", [0, 1]]\n        },\n        fields=[\"name\", \"customer\", \"grand_total\"]\n    )\n    \n    if purchase_invoices or sales_invoices:\n        error_msg = \"Active vouchers found against this Job.\"\n        \n        frappe.throw(error_msg, title=_(\"Cannot cancel Job\"))\n    ",
  "script_type": "DocType Event"
 }
]